name: Deploy on Release

on:
  release:
    types: [published]

jobs:
  extract-component:
    runs-on: ubuntu-latest
    outputs:
      component: ${{ steps.check_tag.outputs.component }}
    steps:
      - name: Extract component from tag
        id: check_tag
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "Tag: $TAG"
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+\/(api|auth|webapp)$ ]]; then
            COMPONENT="${BASH_REMATCH[1]}"
            echo "component=$COMPONENT" >> "$GITHUB_OUTPUT"
          else
            echo "‚ùå Invalid tag format: $TAG"
            exit 1
          fi

  deploy-api:
    needs: extract-component
    uses: ./.github/workflows/templates/deploy-template.yml
    with:
      component: api
      folder: api-fchat-2
    secrets: inherit

  deploy-webapp:
    needs: extract-component
    uses: ./.github/workflows/deploy-template.yml
    with:
      component: webapp
      folder: webapp-fchat
    secrets: inherit

  deploy-auth:
    needs: extract-component
    uses: ./.github/workflows/deploy-template.yml
    with:
      component: auth
      folder: auth-fchat
    secrets: inherit
